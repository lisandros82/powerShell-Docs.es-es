---
ms.date: 06/05/2017
keywords: powershell, cmdlet
title: WinRMSecurity
ms.openlocfilehash: 59717e4806857e6760de523335bbee6028da8e84
ms.sourcegitcommit: debd2b38fb8070a7357bf1a4bf9cc736f3702f31
ms.translationtype: HT
ms.contentlocale: es-ES
ms.lasthandoff: 12/05/2019
ms.locfileid: "62086378"
---
# <a name="powershell-remoting-security-considerations"></a><span data-ttu-id="0cd1c-103">Consideraciones de seguridad de comunicación remota de PowerShell</span><span class="sxs-lookup"><span data-stu-id="0cd1c-103">PowerShell Remoting Security Considerations</span></span>

<span data-ttu-id="0cd1c-104">La comunicación remota de PowerShell es la forma recomendada para administrar los sistemas de Windows.</span><span class="sxs-lookup"><span data-stu-id="0cd1c-104">PowerShell Remoting is the recommended way to manage Windows systems.</span></span> <span data-ttu-id="0cd1c-105">La comunicación remota de PowerShell está habilitada de forma predeterminada en Windows Server 2012 R2.</span><span class="sxs-lookup"><span data-stu-id="0cd1c-105">PowerShell Remoting is enabled by default in Windows Server 2012 R2.</span></span> <span data-ttu-id="0cd1c-106">En este documento se tratan cuestiones de seguridad, recomendaciones y procedimientos recomendados para el uso de la comunicación remota de PowerShell.</span><span class="sxs-lookup"><span data-stu-id="0cd1c-106">This document covers security concerns, recommendations, and best practices when using PowerShell Remoting.</span></span>

## <a name="what-is-powershell-remoting"></a><span data-ttu-id="0cd1c-107">¿Qué es la comunicación remota de PowerShell?</span><span class="sxs-lookup"><span data-stu-id="0cd1c-107">What is PowerShell Remoting?</span></span>

<span data-ttu-id="0cd1c-108">La comunicación remota de PowerShell usa [Administración remota de Windows (WinRM)](https://msdn.microsoft.com/library/windows/desktop/aa384426.aspx), que es la implementación de Microsoft del protocolo [Servicios web para administración (WS-Management)](https://www.dmtf.org/sites/default/files/standards/documents/DSP0226_1.2.0.pdf), que permite a los usuarios ejecutar comandos de PowerShell en equipos remotos.</span><span class="sxs-lookup"><span data-stu-id="0cd1c-108">PowerShell Remoting uses [Windows Remote Management (WinRM)](https://msdn.microsoft.com/library/windows/desktop/aa384426.aspx), which is the Microsoft implementation of the [Web Services for Management (WS-Management)](https://www.dmtf.org/sites/default/files/standards/documents/DSP0226_1.2.0.pdf) protocol, to allow users to run PowerShell commands on remote computers.</span></span> <span data-ttu-id="0cd1c-109">Puede encontrar más información acerca del uso de la comunicación remota de PowerShell en [Ejecutar comandos remotos](https://technet.microsoft.com/library/dd819505.aspx).</span><span class="sxs-lookup"><span data-stu-id="0cd1c-109">You can find more information about using PowerShell Remoting at [Running Remote Commands](https://technet.microsoft.com/library/dd819505.aspx).</span></span>

<span data-ttu-id="0cd1c-110">La comunicación remota de PowerShell no es lo mismo que usar el parámetro **ComputerName** de un cmdlet para ejecutarlo en un equipo remoto, que usa la llamada a procedimiento remoto (RPC) como protocolo subyacente.</span><span class="sxs-lookup"><span data-stu-id="0cd1c-110">PowerShell Remoting is not the same as using the **ComputerName** parameter of a cmdlet to run it on a remote computer, which uses Remote Procedure Call (RPC) as its underlying protocol.</span></span>

## <a name="powershell-remoting-default-settings"></a><span data-ttu-id="0cd1c-111">Configuración predeterminada de la comunicación remota de PowerShell</span><span class="sxs-lookup"><span data-stu-id="0cd1c-111">PowerShell Remoting default settings</span></span>

<span data-ttu-id="0cd1c-112">La comunicación remota de PowerShell (y WinRM) escucha los puertos siguientes:</span><span class="sxs-lookup"><span data-stu-id="0cd1c-112">PowerShell Remoting (and WinRM) listen on the following ports:</span></span>

- <span data-ttu-id="0cd1c-113">HTTP: 5985</span><span class="sxs-lookup"><span data-stu-id="0cd1c-113">HTTP: 5985</span></span>
- <span data-ttu-id="0cd1c-114">HTTPS: 5986</span><span class="sxs-lookup"><span data-stu-id="0cd1c-114">HTTPS: 5986</span></span>

<span data-ttu-id="0cd1c-115">De manera predeterminada, la comunicación remota de PowerShell solo permite conexiones de los miembros del grupo Administradores.</span><span class="sxs-lookup"><span data-stu-id="0cd1c-115">By default, PowerShell Remoting only allows connections from members of the Administrators group.</span></span> <span data-ttu-id="0cd1c-116">Las sesiones se inician en el contexto del usuario, por lo que todos los controles de acceso del sistema operativo que se aplican a usuarios individuales y grupos continuarán aplicándose a estos mientras estén conectados a través de la comunicación remota de PowerShell.</span><span class="sxs-lookup"><span data-stu-id="0cd1c-116">Sessions are launched under the user's context, so all operating system access controls applied to individual users and groups continue to apply to them while connected over PowerShell Remoting.</span></span>

<span data-ttu-id="0cd1c-117">En redes privadas, la regla de Firewall de Windows predeterminada para la comunicación remota de PowerShell acepta todas las conexiones.</span><span class="sxs-lookup"><span data-stu-id="0cd1c-117">On private networks, the default Windows Firewall rule for PowerShell Remoting accepts all connections.</span></span> <span data-ttu-id="0cd1c-118">En redes públicas, la regla predeterminada del Firewall de Windows permite las conexiones de comunicación remota de PowerShell únicamente desde dentro de la misma subred.</span><span class="sxs-lookup"><span data-stu-id="0cd1c-118">On public networks, the default Windows Firewall rule allows PowerShell Remoting connections only from within the same subnet.</span></span> <span data-ttu-id="0cd1c-119">Tendrá que cambiar explícitamente esa regla para abrir la comunicación remota de PowerShell a todas las conexiones de una red pública.</span><span class="sxs-lookup"><span data-stu-id="0cd1c-119">You have to explicitly change that rule to open PowerShell Remoting to all connections on a public network.</span></span>

><span data-ttu-id="0cd1c-120">**Advertencia:** La regla de firewall para redes públicas está diseñada para proteger el equipo frente a los intentos de conexión externa potencialmente malintencionados.</span><span class="sxs-lookup"><span data-stu-id="0cd1c-120">**Warning:** The firewall rule for public networks is meant to protect the computer from potentially malicious external connection attempts.</span></span> <span data-ttu-id="0cd1c-121">Tenga precaución al quitar esta regla.</span><span class="sxs-lookup"><span data-stu-id="0cd1c-121">Use caution when removing this rule.</span></span>

## <a name="process-isolation"></a><span data-ttu-id="0cd1c-122">Aislamiento de procesos</span><span class="sxs-lookup"><span data-stu-id="0cd1c-122">Process isolation</span></span>

<span data-ttu-id="0cd1c-123">La comunicación remota de PowerShell usa [Administración remota de Windows (WinRM)](https://msdn.microsoft.com/library/windows/desktop/aa384426) para la comunicación entre equipos.</span><span class="sxs-lookup"><span data-stu-id="0cd1c-123">PowerShell Remoting uses [Windows Remote Management (WinRM)](https://msdn.microsoft.com/library/windows/desktop/aa384426) for communication between computers.</span></span>
<span data-ttu-id="0cd1c-124">WinRM se ejecuta como servicio en la cuenta servicio de red y genera procesos aislados que se ejecutan como cuentas de usuario para las instancias de host de PowerShell.</span><span class="sxs-lookup"><span data-stu-id="0cd1c-124">WinRM runs as a service under the Network Service account, and spawns isolated processes running as user accounts to host PowerShell instances.</span></span> <span data-ttu-id="0cd1c-125">Una instancia de PowerShell que se ejecuta como un usuario no tiene acceso a un proceso que ejecuta una instancia de PowerShell como otro usuario.</span><span class="sxs-lookup"><span data-stu-id="0cd1c-125">An instance of PowerShell running as one user has no access to a process running an instance of PowerShell as another user.</span></span>

## <a name="event-logs-generated-by-powershell-remoting"></a><span data-ttu-id="0cd1c-126">Registros de eventos generados por la comunicación remota de PowerShell</span><span class="sxs-lookup"><span data-stu-id="0cd1c-126">Event logs generated by PowerShell Remoting</span></span>

<span data-ttu-id="0cd1c-127">FireEye ha proporcionado un buen resumen de los registros de eventos y otras pruebas de seguridad generados por las sesiones de comunicación remota de PowerShell, disponible en [Investigating PowerShell Attacks](https://www.fireeye.com/content/dam/fireeye-www/global/en/solutions/pdfs/wp-lazanciyan-investigating-powershell-attacks.pdf) (Investigación de los ataques de PowerShell).</span><span class="sxs-lookup"><span data-stu-id="0cd1c-127">FireEye has provided a good summary of the event logs and other security evidence generated by PowerShell Remoting sessions, available at [Investigating PowerShell Attacks](https://www.fireeye.com/content/dam/fireeye-www/global/en/solutions/pdfs/wp-lazanciyan-investigating-powershell-attacks.pdf).</span></span>

## <a name="encryption-and-transport-protocols"></a><span data-ttu-id="0cd1c-128">Protocolos de transporte y cifrado</span><span class="sxs-lookup"><span data-stu-id="0cd1c-128">Encryption and transport protocols</span></span>

<span data-ttu-id="0cd1c-129">Resulta útil tener en cuenta la seguridad de una conexión de comunicación remota de PowerShell desde dos perspectivas: autenticación inicial y comunicación continua.</span><span class="sxs-lookup"><span data-stu-id="0cd1c-129">It is helpful to consider the security of a PowerShell Remoting connection from two perspectives: initial authentication, and ongoing communication.</span></span>

<span data-ttu-id="0cd1c-130">Independientemente del protocolo de transporte utilizado (HTTP o HTTPS), la comunicación remota de PowerShell siempre cifra toda la comunicación tras la autenticación inicial con una clave simétrica AES-256 por sesión.</span><span class="sxs-lookup"><span data-stu-id="0cd1c-130">Regardless of the transport protocol used (HTTP or HTTPS), PowerShell Remoting always encrypts all communication after initial authentication with a per-session AES-256 symmetric key.</span></span>

### <a name="initial-authentication"></a><span data-ttu-id="0cd1c-131">Autenticación inicial</span><span class="sxs-lookup"><span data-stu-id="0cd1c-131">Initial authentication</span></span>

<span data-ttu-id="0cd1c-132">La autenticación confirma la identidad del cliente al servidor, e idealmente, del servidor al cliente.</span><span class="sxs-lookup"><span data-stu-id="0cd1c-132">Authentication confirms the identity of the client to the server - and ideally - the server to the client.</span></span>

<span data-ttu-id="0cd1c-133">Cuando un cliente se conecta a un servidor de dominio mediante su nombre de equipo (por ejemplo: servidor01 o servidor01.contoso.com), el protocolo de autenticación predeterminado es [Kerberos](https://msdn.microsoft.com/library/windows/desktop/aa378747.aspx).</span><span class="sxs-lookup"><span data-stu-id="0cd1c-133">When a client connects to a domain server using its computer name (i.e.: server01, or server01.contoso.com), the default authentication protocol is [Kerberos](https://msdn.microsoft.com/library/windows/desktop/aa378747.aspx).</span></span>
<span data-ttu-id="0cd1c-134">Kerberos garantiza la identidad del usuario y del servidor sin enviar ningún tipo de credencial reutilizable.</span><span class="sxs-lookup"><span data-stu-id="0cd1c-134">Kerberos guarantees both the user identity and server identity without sending any sort of reusable credential.</span></span>

<span data-ttu-id="0cd1c-135">Cuando un cliente se conecta a un servidor de dominio mediante su dirección IP, o se conecta a un servidor de grupo de trabajo, no es posible la autenticación de Kerberos.</span><span class="sxs-lookup"><span data-stu-id="0cd1c-135">When a client connects to a domain server using its IP address, or connects to a workgroup server, Kerberos authentication is not possible.</span></span> <span data-ttu-id="0cd1c-136">En ese caso, la comunicación remota de PowerShell se basa en el [protocolo de autenticación NTLM](https://msdn.microsoft.com/library/windows/desktop/aa378749.aspx).</span><span class="sxs-lookup"><span data-stu-id="0cd1c-136">In that case, PowerShell Remoting relies on the [NTLM authentication protocol](https://msdn.microsoft.com/library/windows/desktop/aa378749.aspx).</span></span> <span data-ttu-id="0cd1c-137">El protocolo de autenticación NTLM garantiza la identidad del usuario sin enviar ningún tipo de credenciales delegables.</span><span class="sxs-lookup"><span data-stu-id="0cd1c-137">The NTLM authentication protocol guarantees the user identity without sending any sort of delegable credential.</span></span> <span data-ttu-id="0cd1c-138">Para demostrar la identidad del usuario, el protocolo NTLM requiere que tanto el cliente como el servidor procesen una clave de sesión de la contraseña del usuario sin intercambiar la propia contraseña.</span><span class="sxs-lookup"><span data-stu-id="0cd1c-138">To prove user identity, the NTLM protocol requires that both the client and server compute a session key from the user's password without ever exchanging the password itself.</span></span> <span data-ttu-id="0cd1c-139">El servidor normalmente no conoce la contraseña del usuario, por lo que se comunica con el controlador de dominio que conoce la contraseña del usuario y calcula la clave de sesión del servidor.</span><span class="sxs-lookup"><span data-stu-id="0cd1c-139">The server typically does not know the user's password, so it communicates with the domain controller, which does know the user's password and calculates the session key for the server.</span></span>

<span data-ttu-id="0cd1c-140">Sin embargo, el protocolo NTLM no garantiza la identidad del servidor.</span><span class="sxs-lookup"><span data-stu-id="0cd1c-140">The NTLM protocol does not, however, guarantee server identity.</span></span> <span data-ttu-id="0cd1c-141">De la misma forma que con todos los protocolos que usan NTLM para la autenticación, un atacante con acceso a una cuenta de equipo unido a un dominio podría invocar el controlador de dominio para procesar una clave de sesión NTLM y, por tanto, suplantar el servidor.</span><span class="sxs-lookup"><span data-stu-id="0cd1c-141">As with all protocols that use NTLM for authentication, an attacker with access to a domain-joined computer's machine account could invoke the domain controller to compute an NTLM session-key and thereby impersonate the server.</span></span>

<span data-ttu-id="0cd1c-142">La autenticación basada en NTLM está deshabilitada de forma predeterminada, pero puede permitirse al configurar SSL en el servidor de destino o el valor WinRM TrustedHosts del cliente.</span><span class="sxs-lookup"><span data-stu-id="0cd1c-142">NTLM-based authentication is disabled by default, but may be permitted by either configuring SSL on the target server, or by configuring the WinRM TrustedHosts setting on the client.</span></span>

#### <a name="using-ssl-certificates-to-validate-server-identity-during-ntlm-based-connections"></a><span data-ttu-id="0cd1c-143">Uso de certificados SSL para validar la identidad del servidor durante las conexiones basadas en NTLM</span><span class="sxs-lookup"><span data-stu-id="0cd1c-143">Using SSL certificates to validate server identity during NTLM-based connections</span></span>

<span data-ttu-id="0cd1c-144">Puesto que el protocolo de autenticación NTLM no puede asegurar la identidad del servidor de destino (solo que ya conoce su contraseña), puede configurar los servidores de destino para usar SSL para la comunicación remota de PowerShell.</span><span class="sxs-lookup"><span data-stu-id="0cd1c-144">Since the NTLM authentication protocol cannot ensure the identity of the target server (only that it already knows your password), you can configure target servers to use SSL for PowerShell Remoting.</span></span> <span data-ttu-id="0cd1c-145">La asignación de un certificado SSL al servidor de destino (si lo emite una entidad emisora de certificados en la que el cliente también confía) habilita la autenticación basada en NTLM que garantiza la identidad del usuario y del servidor.</span><span class="sxs-lookup"><span data-stu-id="0cd1c-145">Assigning a SSL certificate to the target server (if issued by a Certificate Authority that the client also trusts) enables NTLM-based authentication that guarantees both the user identity and server identity.</span></span>

#### <a name="ignoring-ntlm-based-server-identity-errors"></a><span data-ttu-id="0cd1c-146">Omisión de errores de identidad de servidor basados en NTLM</span><span class="sxs-lookup"><span data-stu-id="0cd1c-146">Ignoring NTLM-based server identity errors</span></span>

<span data-ttu-id="0cd1c-147">Si no es factible implementar un certificado SSL en un servidor para las conexiones de NTLM, puede suprimir los errores de identidad resultantes mediante la adición del servidor a la lista WinRM **TrustedHosts**.</span><span class="sxs-lookup"><span data-stu-id="0cd1c-147">If deploying a SSL certificate to a server for NTLM connections is infeasible, you may suppress the resulting identity errors by adding the server to the WinRM **TrustedHosts** list.</span></span> <span data-ttu-id="0cd1c-148">Tenga en cuenta que la adición de un nombre de servidor a la lista TrustedHosts no se debe considerar como ninguna forma de instrucción de la confiabilidad de los mismos hosts, ya que el protocolo de autenticación NTLM no puede garantizar que, en realidad, se está conectando al host al que pretende conectarse.</span><span class="sxs-lookup"><span data-stu-id="0cd1c-148">Please note that adding a server name to the TrustedHosts list should not be considered as any form of statement of the trustworthiness of the hosts themselves - as the NTLM authentication protocol cannot guarantee that you are in fact connecting to the host you are intending to connect to.</span></span>
<span data-ttu-id="0cd1c-149">En su lugar, debe considerar que el valor de TrustedHosts sea la lista de hosts de la que quiere suprimir el error generado por la imposibilidad de comprobar la identidad del servidor.</span><span class="sxs-lookup"><span data-stu-id="0cd1c-149">Instead, you should consider the TrustedHosts setting to be the list of hosts for which you wish to suppress the error generated by being unable to verify the server's identity.</span></span>


### <a name="ongoing-communication"></a><span data-ttu-id="0cd1c-150">Comunicación continua</span><span class="sxs-lookup"><span data-stu-id="0cd1c-150">Ongoing Communication</span></span>

<span data-ttu-id="0cd1c-151">Una vez completada la autenticación inicial, el [Protocolo de comunicación remota de PowerShell](https://msdn.microsoft.com/library/dd357801.aspx) cifra toda la comunicación continua con una clave simétrica AES-256 por sesión.</span><span class="sxs-lookup"><span data-stu-id="0cd1c-151">Once initial authentication is complete, the [PowerShell Remoting Protocol](https://msdn.microsoft.com/library/dd357801.aspx) encrypts all ongoing communication with a per-session AES-256 symmetric key.</span></span>


## <a name="making-the-second-hop"></a><span data-ttu-id="0cd1c-152">Creación del segundo salto</span><span class="sxs-lookup"><span data-stu-id="0cd1c-152">Making the second hop</span></span>

<span data-ttu-id="0cd1c-153">De forma predeterminada, la comunicación remota de PowerShell usa Kerberos (si está disponible) o NTLM para la autenticación.</span><span class="sxs-lookup"><span data-stu-id="0cd1c-153">By default, PowerShell Remoting uses Kerberos (if available) or NTLM for authentication.</span></span> <span data-ttu-id="0cd1c-154">Ambos protocolos se autentican en el equipo remoto sin enviarle credenciales.</span><span class="sxs-lookup"><span data-stu-id="0cd1c-154">Both of these protocols authenticate to the remote machine without sending credentials to it.</span></span>
<span data-ttu-id="0cd1c-155">Este es el modo más seguro de autenticación, pero dado que el equipo remoto no tiene las credenciales de usuario, no puede acceder a otros equipos o servicios en nombre del usuario.</span><span class="sxs-lookup"><span data-stu-id="0cd1c-155">This is the most secure way to authenticate, but because the remote machine does not have the user's credentials, it cannot access other computers and services on the user's behalf.</span></span>
<span data-ttu-id="0cd1c-156">Esto se conoce como el "problema del segundo salto".</span><span class="sxs-lookup"><span data-stu-id="0cd1c-156">This is known as the "second hop problem".</span></span>

<span data-ttu-id="0cd1c-157">Hay varias formas de evitar este problema.</span><span class="sxs-lookup"><span data-stu-id="0cd1c-157">There are several ways to avoid this problem.</span></span> <span data-ttu-id="0cd1c-158">Para obtener descripciones de estos métodos y las ventajas e inconvenientes de cada uno, consulte [Realizar el segundo salto en la comunicación remota de PowerShell](PS-remoting-second-hop.md).</span><span class="sxs-lookup"><span data-stu-id="0cd1c-158">For descriptions of these methods, and the pros and cons of each, see [Making the second hop in PowerShell Remoting](PS-remoting-second-hop.md).</span></span>